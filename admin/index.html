<!DOCTYPE html>
<html>
<head>
	<title>Admin</title>
	<link rel="stylesheet" href="../scenes/stage.css">
	<link rel="stylesheet" href="interface.css">
</head>
<body>

<div id="gui"></div>

<div id="preview">
	<div id="background"></div>
	<div id="stage"></div>
</div>


<script src="../admin/gui.js"></script>
<script src="../primus/primus.js"></script>
<script>
	var preview = document.querySelector('#preview');
	var background = document.querySelector('#background');
	var stage = document.querySelector('#stage');
	var gui = new Gui('#gui');

	var primus = Primus.connect('/primus', {});
	primus.write('admin');
	primus.write({
		type: 'info',
		data: giveinfo()
	});
	console.log('connected');

	primus.on('data', function(msg) {
		if (msg == 'giveinfo') {
			primus.write('admin');
			primus.write({
				type: 'info',
				data: giveinfo()
			});
		} else if (typeof msg === 'object') {
			var d = msg.data;
			console.log(msg);
			switch (msg.type) {
				case 'stage cmd':
					if (d.width)	stage.width = d.width;
					if (d.height)	stage.height = d.height;
					if (typeof d.overlay !== 'undefined') {
						switch (d.overlay) {
							case 'blackout':
								preview.classList.remove('whiteout', 'blankout');
								preview.classList.add('blackout');
								break;
							case 'whiteout':
								preview.classList.remove('blackout', 'blankout');
								preview.classList.add('whiteout');
								break;
							case 'blankout':
								preview.classList.remove('blackout', 'whiteout');
								preview.classList.add('blankout');
								break;
							case null:
								preview.classList.remove('blackout', 'whiteout', 'blankout');
								break;
							default:
								console.warn('unknown overlay ['+d.overlay+']');
						}
					}
					if (d.scene) {
						stage.innerHTML = d.scene;
					}
					break;
				case 'scene cmd':
					break;
				case 'gui settings':
					console.log('rebuilding gui: '+gui.rebuild(d));
					break;
				default:
					console.warn('unknown msg '+JSON.stringify(msg));
					break;
			}
		} else {
			console.warn('unknown msg '+JSON.stringify(msg));
		}
	});

	function giveinfo() {
		return {
			width: window.innerWidth,
			height: window.innerHeight,
			screen: {
				width: window.screen.width,
				height: window.screen.height,
				availWidth: window.screen.availWidth,
				availHeight: window.screen.availHeight,
				availLeft: window.screen.availLeft,
				availTop: window.screen.availTop,
				colorDepth: window.screen.colorDepth,
				pixelDepth: window.screen.pixelDepth,
				orientation: {
					angle: window.screen.orientation.angle,
					type: window.screen.orientation.type
				}
			}
		};
	}

	window.onresize = function() {
		var sw = preview.offsetWidth / stage.offsetWidth;
		var sh = preview.offsetHeight / stage.offsetHeight;
		stage.style.zoom = sw < sh ? sw : sh;
	};
	window.onresize();
</script>

</body>
</html>
